<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f8fafc" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0b1121" media="(prefers-color-scheme: dark)">
    <meta name="description" content="交通誘導員のための現場記録アプリ - Professional Edition">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="現場記録Pro">
    
    <!-- TrafficGuard Pro v2.0.0_P1_6 (UI Polish & Toast Fix) -->
    <title>現場記録 Pro v2.0.0_P1_6</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- 1. LOGGER -->
    <script>
        window.Logger = {
            systemLogs: [], runtimeLogs: [], breadcrumbs: [], maxLogs: 200, hasCriticalError: false,
            init() {
                const oldError = console.error;
                console.error = (...args) => { this.add('ERROR', 'Console', args.join(' ')); oldError.apply(console, args); };
                window.onerror = (msg, src, line, col, err) => { this.add('CRITICAL', 'Window', msg, { src, line, col, stack: err?.stack }); };
                window.onunhandledrejection = (e) => { this.add('CRITICAL', 'Promise', e.reason?.message || String(e.reason), { stack: e.reason?.stack }); };
                document.addEventListener('click', (e) => {
                    try {
                        const target = e.target.closest('button, a, input, select, .clickable');
                        if (target) {
                            let label = target.innerText?.substring(0, 30).replace(/\n/g, ' ') || target.id || target.getAttribute('aria-label') || target.tagName;
                            if (target.dataset.action) label = `[Action: ${target.dataset.action}] ${label}`;
                            this.breadcrumb(`Click: ${label}`);
                        }
                    } catch(err) {}
                }, true);
                this.addSystem('INFO', 'System', 'Logger Initialized. v2.0.0_P1_6');
            },
            addSystem(level, category, message) { this.systemLogs.push({ ts: new Date().toISOString(), lvl: level, cat: category, msg: message }); },
            add(level, category, message, data = null) {
                const entry = { ts: new Date().toISOString(), lvl: level, cat: category, msg: message, data: data };
                this.runtimeLogs.unshift(entry);
                if (this.runtimeLogs.length > this.maxLogs) this.runtimeLogs.pop();
                if ((level === 'ERROR' || level === 'CRITICAL') && window.STATE && window.STATE.devMode && window.STATE.devMode.debugNotify) {
                    this.hasCriticalError = true;
                    if(window.Utils && window.Utils.showErrorToast) window.Utils.showErrorToast(message);
                }
            },
            breadcrumb(action) { this.breadcrumbs.unshift({ ts: new Date().toLocaleTimeString(), act: action }); if (this.breadcrumbs.length > 20) this.breadcrumbs.pop(); },
            exportText() {
                let txt = `TrafficGuard Bug Report (v2.0.0_P1_6)\nDate: ${new Date().toLocaleString()}\nUA: ${navigator.userAgent}\n\n`;
                txt += `[System]\n` + this.systemLogs.map(l => `[${l.ts}] ${l.lvl} [${l.cat}] ${l.msg}`).join('\n') + `\n\n`;
                txt += `[Recent Actions]\n` + this.breadcrumbs.map(b => `${b.ts} - ${b.act}`).join('\n') + `\n\n`;
                txt += `[Logs]\n` + (this.runtimeLogs.length ? this.runtimeLogs.map(l => `[${l.ts}] ${l.lvl} [${l.cat}] ${l.msg} ${l.data ? JSON.stringify(l.data) : ''}`).join('\n') : '(No logs)');
                return txt;
            }
        };
        window.Logger.init();

        // Dark Mode Init
        (function() {
            try {
                const s = localStorage.getItem('theme');
                const d = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (s === 'dark' || (!s && d)) {
                    document.documentElement.classList.add('dark');
                    document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: light)"]').setAttribute('content', '#0b1121');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            } catch(e) {}
        })();
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Noto Sans JP', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                    colors: { 
                        slate: { 850: '#151e32', 950: '#020617' },
                        app: { bg: '#0b1121', card: '#151e32', side: '#0f172a', input: '#1e293b', accent: '#60a5fa', green: '#10b981', danger: '#ef4444', text: '#f1f5f9', muted: '#94a3b8', border: 'rgba(255,255,255,0.08)' }
                    },
                    boxShadow: { 'glow': '0 0 15px rgba(96, 165, 250, 0.5)', 'card': '0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15)' },
                    animation: { 'slide-in-right': 'slideInRight 0.25s ease-out forwards', 'slide-in-left': 'slideInLeft 0.25s ease-out forwards', 'fade-in': 'fadeIn 0.2s ease-out forwards' },
                    keyframes: {
                        slideInRight: { '0%': { transform: 'translateX(20%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        slideInLeft: { '0%': { transform: 'translateX(-20%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        html, body { height: 100%; overflow: hidden; touch-action: pan-x pan-y; }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; display: flex; flex-direction: column; background-color: #f8fafc; color: #334155; transition: background-color 0.3s, color 0.3s; }
        html.dark body { background-color: #0b1121; color: #f1f5f9; }
        .main-content { flex-grow: 1; overflow-y: auto; padding-bottom: 120px; padding-top: 10px; overscroll-behavior-y: contain; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .header-glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        html.dark .header-glass { background: rgba(11, 17, 33, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .modern-card { background-color: white; border-radius: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid rgba(241, 245, 249, 1); }
        html.dark .modern-card { background-color: #151e32; border-color: rgba(255,255,255,0.05); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        .modern-input { background-color: #f8fafc; border: 1px solid #e2e8f0; color: #1e293b; border-radius: 0.75rem; appearance: none; transition: all 0.2s; }
        .modern-input:focus { background-color: white; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        html.dark .modern-input { background-color: #1e293b; border-color: #374151; color: white; }
        html.dark .modern-input:focus { background-color: #111827; border-color: #60a5fa; }
        .backdrop { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .backdrop.active { opacity: 1; pointer-events: auto; }
        .modal-sheet { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(100%); }
        .modal-sheet.active { transform: translateY(0); }
        .full-screen-sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; background-color: #f8fafc; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        html.dark .full-screen-sheet { background-color: #0b1121; }
        .full-screen-sheet.active { transform: translateY(0); }
        .side-menu-panel { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(-100%); }
        .side-menu-panel.active { transform: translateX(0); }
        
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; position: relative; border-radius: 999px; font-weight: 500; }
        .calendar-day.has-record::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background-color: #3b82f6; border-radius: 50%; }
        .calendar-day.is-today { border: 2px solid #3b82f6; color: #3b82f6; font-weight: 700; }
        .calendar-day.is-selected { background-color: #3b82f6; color: white; border: none; }
        
        /* New Toast (Non-blocking) */
        #toast { visibility: hidden; min-width: 90%; margin-left: -45%; background-color: #1e293b; color: #fff; text-align: center; border-radius: 99px; padding: 12px 20px; position: fixed; z-index: 100; left: 50%; bottom: 30px; opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.4); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; pointer-events: none; }
        html.dark #toast { background-color: #334155; color: #f1f5f9; border: 1px solid rgba(255,255,255,0.1); }
        #toast.show { visibility: visible; opacity: 1; transform: translateY(0); }
        
        #error-toast { visibility: hidden; width: 90%; margin-left: -45%; background-color: #ef4444; color: white; border-radius: 12px; padding: 12px; position: fixed; z-index: 110; left: 50%; bottom: 30px; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; box-shadow: 0 10px 40px -5px rgba(239, 68, 68, 0.6); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        #error-toast.show { visibility: visible; opacity: 1; transform: translateY(0); }
        
        /* Custom Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #60a5fa; }
        .toggle-checkbox:checked + .toggle-label { background-color: #60a5fa; }
        
        .timeline-item { position: relative; padding-left: 24px; padding-bottom: 32px; border-left: 2px solid #e2e8f0; }
        html.dark .timeline-item { border-left-color: #334155; }
        .timeline-item:last-child { border-left-color: transparent; }
        .timeline-dot { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; border-radius: 50%; background-color: #3b82f6; border: 2px solid #fff; }
        html.dark .timeline-dot { border-color: #0f172a; }
        
        #map-area { touch-action: none; }
        .text-truncate-custom { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; word-break: break-all; }
        .text-expanded { -webkit-line-clamp: unset !important; display: block !important; }
        
        /* Note Accordion Fix */
        .note-content { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height: 0; opacity: 0; overflow: hidden; transform-origin: top; transform: scaleY(0.95); }
        .note-content.expanded { max-height: 500px; opacity: 1; transform: scaleY(1); margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(148, 163, 184, 0.1); }
        
        .badge-pro { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }
        .clickable { cursor: pointer; } 
    </style>
</head>
<body>

    <div id="sidemenu-backdrop" class="backdrop fixed inset-0 z-40"></div>
    <div id="modal-backdrop" class="backdrop fixed inset-0 z-[65]"></div>
    <div id="dialog-modal-backdrop" class="backdrop fixed inset-0 z-[80] flex items-center justify-center p-4 hidden">
        <div id="dialog-modal-content" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-100 border border-slate-100 dark:border-slate-700"></div>
    </div>

    <!-- Side Menu -->
    <div id="side-menu" class="side-menu-panel fixed top-0 left-0 h-full w-80 bg-white dark:bg-app-bg shadow-2xl z-50 flex flex-col safe-area-top safe-area-bottom">
        <div class="p-6 border-b border-gray-100 dark:border-app-border flex justify-between items-center bg-gray-50/80 dark:bg-app-card/80">
            <div>
                <h2 class="text-xl font-bold tracking-tight text-slate-800 dark:text-white flex items-center gap-2">メニュー <span class="badge-pro">PRO</span></h2>
                <p class="text-xs text-slate-500 dark:text-app-muted mt-0.5 font-mono">v2.0.0_P1_6</p>
            </div>
            <button data-action="close-menu" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 dark:bg-app-input text-slate-500 dark:text-app-muted"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto p-4 space-y-2">
            <div class="py-2">
                <p class="px-3 text-[10px] font-bold text-slate-400 dark:text-app-muted uppercase tracking-widest mb-2">データ資産</p>
                <div class="space-y-1">
                    <button data-action="backup" class="w-full flex items-center p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input transition-colors text-slate-700 dark:text-app-text">
                        <i class="fas fa-download w-6 text-center text-blue-500 mr-2"></i><span class="font-medium text-sm">データを保存 (バックアップ)</span>
                    </button>
                    <button data-action="restore" class="w-full flex items-center p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input transition-colors text-slate-700 dark:text-app-text">
                        <i class="fas fa-upload w-6 text-center text-emerald-500 mr-2"></i><span class="font-medium text-sm">データを復元</span>
                    </button>
                </div>
            </div>
            <div class="py-2 border-t border-gray-100 dark:border-app-border">
                <p class="px-3 text-[10px] font-bold text-slate-400 dark:text-app-muted uppercase tracking-widest mb-2">設定 & セキュリティ</p>
                <div class="space-y-1">
                    <button data-action="settings-labels" class="w-full flex items-center p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input transition-colors text-slate-700 dark:text-app-text">
                        <i class="fas fa-tags w-6 text-center text-orange-500 mr-2"></i><span class="font-medium text-sm">ラベル管理</span>
                    </button>
                    <button data-action="settings-secure" class="w-full flex items-center p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input transition-colors text-slate-700 dark:text-app-text">
                        <i class="fas fa-shield-alt w-6 text-center text-amber-500 mr-2"></i><span class="font-medium text-sm">接続情報・AI設定</span>
                    </button>
                    <!-- Improved Dark Mode Toggle -->
                    <div class="flex items-center justify-between p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input">
                        <div class="flex items-center"><i class="fas fa-moon w-6 text-center text-indigo-500 mr-2"></i><span class="font-medium text-sm text-slate-700 dark:text-app-text">ダークモード</span></div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            </div>
            <div class="py-2 border-t border-gray-100 dark:border-app-border">
                <p class="px-3 text-[10px] font-bold text-slate-400 dark:text-app-muted uppercase tracking-widest mb-2">サポート</p>
                <div class="space-y-1">
                    <button data-action="show-history" class="w-full flex items-center p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input transition-colors text-slate-700 dark:text-app-text">
                        <i class="fas fa-history w-6 text-center text-purple-500 mr-2"></i><span class="font-medium text-sm">更新履歴 (Timeline)</span>
                    </button>
                    <button data-action="show-debug" class="w-full flex items-center p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input transition-colors text-slate-700 dark:text-app-text">
                        <i class="fas fa-bug w-6 text-center text-red-500 mr-2"></i><span class="font-medium text-sm">不具合報告・ログ</span>
                    </button>
                    <button data-action="show-about" class="w-full flex items-center p-3 rounded-xl active:bg-slate-100 dark:active:bg-app-input transition-colors text-slate-700 dark:text-app-text">
                        <i class="fas fa-info-circle w-6 text-center text-sky-500 mr-2"></i><span class="font-medium text-sm">このアプリについて</span>
                    </button>
                </div>
            </div>
            
            <div class="py-2 mt-2 bg-slate-50 dark:bg-app-input/30 rounded-xl p-2 border border-slate-100 dark:border-app-border">
                <button data-action="toggle-accordion" data-target="dev-menu" class="w-full flex items-center justify-between px-2 py-1 text-xs text-slate-500 dark:text-slate-400 font-bold">
                    <span><i class="fas fa-code mr-1"></i> 開発者メニュー (Dev Mode)</span>
                    <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                </button>
                <div id="dev-menu" class="hidden pl-1 mt-2 space-y-2">
                    <div class="flex items-center justify-between p-2 rounded bg-white dark:bg-app-input border border-slate-100 dark:border-app-border">
                         <span class="text-xs font-bold text-slate-600 dark:text-slate-300">デバッグ通知</span>
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="debug-notify-toggle" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-red-500"></div>
                        </label>
                    </div>
                    <div class="space-y-1">
                        <button data-action="dl-manifest" class="w-full text-left p-2 rounded text-xs font-mono text-slate-600 bg-white active:bg-slate-100 dark:text-app-muted dark:bg-app-input dark:active:bg-slate-800 border border-slate-100 dark:border-app-border"><i class="fas fa-file-code mr-2 text-orange-500"></i>1. manifest.json</button>
                        <button data-action="dl-sw" class="w-full text-left p-2 rounded text-xs font-mono text-slate-600 bg-white active:bg-slate-100 dark:text-app-muted dark:bg-app-input dark:active:bg-slate-800 border border-slate-100 dark:border-app-border"><i class="fas fa-cogs mr-2 text-teal-500"></i>2. service-worker.js</button>
                        <button data-action="dl-icon" class="w-full text-left p-2 rounded text-xs font-mono text-slate-600 bg-white active:bg-slate-100 dark:text-app-muted dark:bg-app-input dark:active:bg-slate-800 border border-slate-100 dark:border-app-border"><i class="fas fa-image mr-2 text-blue-500"></i>3. icon-192.png</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header-glass sticky top-0 z-30 w-full safe-area-top">
        <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
            <button data-action="toggle-menu" class="w-10 h-10 rounded-full bg-white/50 dark:bg-app-input/50 active:bg-slate-100 dark:active:bg-app-input flex items-center justify-center text-slate-600 dark:text-slate-300 shadow-sm border border-slate-100 dark:border-app-border transition-transform">
                <i class="fas fa-bars"></i>
            </button>
            <div class="flex items-center space-x-2 bg-slate-100/50 dark:bg-app-input/50 p-1 rounded-full border border-slate-200/50 dark:border-app-border backdrop-blur-md">
                <button data-action="prev-day" class="w-10 h-8 rounded-full flex items-center justify-center text-slate-500 active:bg-white dark:active:bg-app-card transition-colors"><i class="fas fa-chevron-left text-xs"></i></button>
                <button data-action="show-calendar" id="current-date-display" class="px-2 text-base font-bold text-slate-800 dark:text-white min-w-[140px] text-center active:opacity-70"><!-- Date --></button>
                <button data-action="next-day" class="w-10 h-8 rounded-full flex items-center justify-center text-slate-500 active:bg-white dark:active:bg-app-card transition-colors"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>
            <div class="w-10"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content px-4">
        <div class="max-w-3xl mx-auto space-y-6">
            <section class="modern-card p-5 relative overflow-hidden">
                <div class="flex justify-between items-center relative z-20 mb-4">
                    <h2 class="text-lg font-bold text-slate-700 dark:text-white flex items-center"><i class="fas fa-briefcase mr-2 text-blue-500"></i>本日の業務情報</h2>
                    <button data-action="edit-daily-info" class="cursor-pointer relative z-30 text-xs font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full active:bg-blue-100 dark:active:bg-blue-900/50 border border-blue-100 dark:border-blue-800/30 transition-transform active:scale-95">編集</button>
                </div>
                <div id="daily-info-display" class="relative z-10 space-y-3"></div>
            </section>
            <section>
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-3 pl-1 flex items-center"><i class="fas fa-map-marker-alt mr-2 text-red-500"></i>現場ごとの記録</h2>
                <div id="sites-list" class="space-y-4"></div>
            </section>
        </div>
    </main>

    <button data-action="add-site" class="fixed bottom-8 right-6 w-16 h-16 rounded-full shadow-glow bg-blue-600 text-white flex items-center justify-center text-2xl z-20 active:scale-95 transition-transform"><i class="fas fa-plus"></i></button>

    <div id="site-record-view" class="full-screen-sheet safe-area-top safe-area-bottom"></div>
    <div id="general-full-screen-view" class="full-screen-sheet safe-area-top safe-area-bottom"></div>

    <div id="modal-content" class="modal-sheet fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-app-bg rounded-t-[2rem] shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.2)] max-h-[94vh] flex flex-col safe-area-bottom">
        <div id="modal-drag-handle" class="w-full py-4 flex justify-center cursor-grab touch-none flex-shrink-0 bg-white dark:bg-app-bg rounded-t-[2rem]"><div class="w-12 h-1.5 bg-slate-200 dark:bg-app-input rounded-full"></div></div>
        <div id="modal-body" class="overflow-y-auto px-6 pb-8 flex-grow"></div>
    </div>

    <!-- Improved Toast -->
    <div id="toast"></div>
    <div id="error-toast">
        <div class="flex items-center gap-3">
            <i class="fas fa-bug text-xl animate-pulse"></i>
            <div class="flex flex-col">
                <span class="text-xs font-bold opacity-80">エラー検出</span>
                <span id="error-toast-msg" class="text-xs truncate max-w-[180px]">Details...</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="window.Handlers.copyLastError()" class="bg-white/20 px-3 py-1.5 rounded-lg text-xs font-bold active:bg-white/30">コピー</button>
            <button onclick="window.Utils.hideErrorToast()" class="bg-white/20 w-8 h-8 rounded-lg flex items-center justify-center active:bg-white/30"><i class="fas fa-times"></i></button>
        </div>
    </div>
    
    <input type="file" id="restore-input" class="hidden" accept=".json">

    <script>
    /** TrafficGuard Pro v2.0.0_P1_6 (UI Polish) */
    
    window.CONFIG = { appVersion: 'v2.0.0_P1_6', dbVersion: '2.0', defaultLabelTrees: { company: [], jobType: [], teamName: [], workDetail: [] } };
    
    window.STATE = {
        secrets: {
            googleMapsKey: localStorage.getItem('trafficGuardApiKey') || '',
            geminiKey: localStorage.getItem('trafficGuardGeminiKey') || '',
            aiProvider: localStorage.getItem('trafficGuardAiProvider') || 'gemini',
            aiModel: localStorage.getItem('trafficGuardAiModel') || 'gemini-1.5-flash',
            aiPersona: localStorage.getItem('trafficGuardAiPersona') || 'app-default'
        },
        devMode: { debugNotify: true },
        currentDate: new Date(),
        calendarDate: new Date(),
        allData: {},
        labelTrees: CONFIG.defaultLabelTrees,
        nextLabelId: 1,
        calendarView: 'day',
        modalDragging: false,
        modalStartY: 0,
        lastErrorMsg: ''
    };

    window.CHANGELOG = [
        { version: 'v2.0.0_P1_6', date: '2025/12/21', title: 'UI Polish', desc: 'UIの改善と視認性向上。', details: ['【UI】ダークモードスイッチのデザイン修正', '【Fix】備考欄の表示崩れ修正', '【Toast】通知を目に優しい配色に変更し、操作を阻害しないよう改善'] },
        { version: 'v2.0.0_P1_5', date: '2025/12/21', title: 'Stability Fix', desc: '不具合の完全修正。', details: ['【Critical Fix】ボタン操作時のエラーを解消'] },
        { version: 'v2.0.0_P1_3', date: '2025/12/21', title: 'Phase 1.3: Context Logging', desc: 'ログ情報の詳細化。', details: ['【Enhanced Logs】ユーザー操作ログの詳細化'] },
        { version: 'v2.0.0_P1_2', date: '2025/12/21', title: 'Phase 1.2: Dev Mode', desc: '開発者モードの実装。', details: ['【Dev Mode】開発者メニューとデバッグ通知'] },
        { version: 'v2.0.0_P1', date: '2025/12/20', title: 'Phase 1: Foundation', desc: 'プロフェッショナル版への再構築。', details: ['【Anti-Bug System】エラーログ収集システム', '【Secure Vault】APIキー保護'] }
    ];

    window.currentMarker = null; window.userLocationMarker = null; window.locationWatchId = null;

    window.DOM = {
        body: document.body, sideMenu: document.getElementById('side-menu'),
        backdrops: { menu: document.getElementById('sidemenu-backdrop'), modal: document.getElementById('modal-backdrop'), dialog: document.getElementById('dialog-modal-backdrop') },
        toggles: { dark: document.getElementById('dark-mode-toggle'), debug: document.getElementById('debug-notify-toggle') },
        displays: { date: document.getElementById('current-date-display'), daily: document.getElementById('daily-info-display'), sites: document.getElementById('sites-list') },
        modal: { container: document.getElementById('modal-content'), body: document.getElementById('modal-body'), handle: document.getElementById('modal-drag-handle') },
        fullScreen: document.getElementById('site-record-view'),
        generalFullScreen: document.getElementById('general-full-screen-view'),
        dialog: { content: document.getElementById('dialog-modal-content') },
        toast: document.getElementById('toast'), errorToast: document.getElementById('error-toast'), inputRestore: document.getElementById('restore-input')
    };

    window.Utils = {
        formatKey: (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`,
        parseAddress: (full) => { const m = full.match(/〒(\d{3}-\d{4})/); return m ? { postal: m[1], addr: full.replace(m[0], '').trim() } : { postal: '', addr: full }; },
        getTodayData: () => {
            const key = Utils.formatKey(STATE.currentDate);
            if (!STATE.allData[key]) STATE.allData[key] = { dailyInfo: { company:'', jobType:'', teamName:'', projectName:'', notes:'' }, sites: [] };
            return STATE.allData[key];
        },
        showToast: (msg, type = 'success') => {
            const icon = type === 'error' ? 'fa-exclamation-triangle text-red-400' : 'fa-check text-emerald-400';
            const finalIcon = type === 'neutral' ? 'fa-info-circle text-blue-400' : icon;
            DOM.toast.innerHTML = `<i class="fas ${finalIcon}"></i><span>${msg}</span><button onclick="this.parentElement.classList.remove('show')" style="pointer-events:auto; margin-left:auto; opacity:0.6;"><i class="fas fa-times"></i></button>`; 
            DOM.toast.classList.add('show');
            setTimeout(() => DOM.toast.classList.remove('show'), 3000);
        },
        showErrorToast: (msg) => {
            STATE.lastErrorMsg = msg;
            document.getElementById('error-toast-msg').innerText = msg;
            DOM.errorToast.classList.add('show');
        },
        hideErrorToast: () => { DOM.errorToast.classList.remove('show'); },
        downloadFile: (name, content) => {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = name; a.style.display = 'none';
            document.body.appendChild(a); a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
        },
        copyToClipboard: async (text) => {
            try { await navigator.clipboard.writeText(text); Utils.showToast('コピーしました'); } 
            catch (err) { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); Utils.showToast('コピーしました'); }
        }
    };

    window.Storage = {
        init: async () => {
            if (navigator.storage && navigator.storage.persist) {
                const isPersisted = await navigator.storage.persist();
                Logger.addSystem('INFO', 'System', `Storage Persistence: ${isPersisted ? 'Granted' : 'Denied'}`);
            }
            Storage.load();
            Storage.loadLabels();
            const dev = localStorage.getItem('trafficGuardDevMode');
            if (dev) STATE.devMode = JSON.parse(dev);
            if (DOM.toggles.debug) DOM.toggles.debug.checked = STATE.devMode.debugNotify;
        },
        save: () => localStorage.setItem('trafficGuardData', JSON.stringify(STATE.allData)),
        load: () => { const d = localStorage.getItem('trafficGuardData'); if (d) STATE.allData = JSON.parse(d); },
        saveLabels: () => localStorage.setItem('trafficGuardLabelTrees', JSON.stringify(STATE.labelTrees)),
        loadLabels: () => {
            const t = localStorage.getItem('trafficGuardLabelTrees');
            if (t) { STATE.labelTrees = JSON.parse(t); let max = 0; Object.values(STATE.labelTrees).forEach(tree => { if (Array.isArray(tree)) tree.forEach(n => max = Math.max(max, n.id)); }); STATE.nextLabelId = max + 1; }
        },
        saveSecrets: () => {
            localStorage.setItem('trafficGuardApiKey', STATE.secrets.googleMapsKey);
            localStorage.setItem('trafficGuardGeminiKey', STATE.secrets.geminiKey);
            localStorage.setItem('trafficGuardAiProvider', STATE.secrets.aiProvider);
            localStorage.setItem('trafficGuardAiModel', STATE.secrets.aiModel);
            localStorage.setItem('trafficGuardAiPersona', STATE.secrets.aiPersona);
            Logger.addSystem('INFO', 'Vault', 'Secrets updated');
        },
        saveDevMode: () => { localStorage.setItem('trafficGuardDevMode', JSON.stringify(STATE.devMode)); }
    };

    window.UI = {
        initTheme: () => { const isDark = document.documentElement.classList.contains('dark'); if(DOM.toggles.dark) DOM.toggles.dark.checked = isDark; },
        toggleTheme: () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: dark)"]').setAttribute('content', '#0b1121');
            document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: light)"]').setAttribute('content', '#f8fafc');
        },
        openMenu: () => { DOM.backdrops.menu.classList.add('active'); DOM.sideMenu.classList.add('active'); },
        closeMenu: () => { DOM.backdrops.menu.classList.remove('active'); DOM.sideMenu.classList.remove('active'); },
        
        renderPage: () => {
            try {
                const d = STATE.currentDate;
                const dayStr = ['日','月','火','水','木','金','土'][d.getDay()];
                DOM.displays.date.innerHTML = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} <span class="font-normal opacity-80">(${dayStr})</span>`;
                
                const data = Utils.getTodayData();
                const di = data.dailyInfo;
                const row = (label, val) => `<div class="flex flex-col sm:flex-row sm:items-baseline border-b border-dashed border-slate-100 dark:border-app-border pb-2 last:border-0"><span class="text-[10px] font-bold text-slate-400 dark:text-app-muted uppercase tracking-wide w-24 flex-shrink-0">${label}</span><span class="text-base font-medium text-slate-700 dark:text-white ${!val?'text-slate-400 italic':''}">${val||'未設定'}</span></div>`;
                
                DOM.displays.daily.innerHTML = `${row('会社名', di.company)}${row('仕事の種類', di.jobType)}${row('班名', di.teamName)}${row('工事名', di.projectName)}<div class="pt-1"><span class="text-[10px] font-bold text-slate-400 dark:text-app-muted uppercase tracking-wide block mb-1">備考</span><p class="text-sm text-slate-600 dark:text-app-text whitespace-pre-wrap bg-slate-50 dark:bg-app-input/50 p-2 rounded-lg border border-slate-100 dark:border-transparent">${di.notes||'なし'}</p></div>`;
                
                if (data.sites.length === 0) {
                    DOM.displays.sites.innerHTML = `<div class="text-center py-12 opacity-40"><i class="fas fa-clipboard-list text-3xl text-slate-300 dark:text-slate-600 mb-2"></i><p class="text-xs">記録なし</p></div>`;
                } else {
                    DOM.displays.sites.innerHTML = data.sites.map((site, i) => {
                        let mapUrl = site.mapLink;
                        const ua = navigator.userAgent;
                        const isAndroid = /Android/i.test(ua);
                        const isIOS = /iPhone|iPad|iPod/i.test(ua);
                        if (site.lat && site.lng) {
                             if (isAndroid) mapUrl = `geo:${site.lat},${site.lng}?q=${site.lat},${site.lng}`;
                             else if (isIOS) mapUrl = `comgooglemaps://?q=${site.lat},${site.lng}`;
                             else mapUrl = `https://www.google.com/maps/search/?api=1&query=${site.lat},${site.lng}`;
                        } else {
                             if (isAndroid && site.address) mapUrl = `geo:0,0?q=${encodeURIComponent(site.address)}`;
                             else if (isIOS && site.address) mapUrl = `comgooglemaps://?q=${encodeURIComponent(site.address)}`;
                             else if (site.address) mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.address)}`;
                        }
                        const hasNote = site.notes && site.notes.trim().length > 0;
                        return `
                        <div class="bg-white dark:bg-app-card rounded-xl overflow-hidden shadow-card border border-slate-100 dark:border-app-border p-1 mb-3">
                            <div class="flex gap-1">
                                <div class="flex-grow flex flex-col gap-1 overflow-hidden min-w-0">
                                    <div class="flex items-stretch min-h-[90px]">
                                        <div class="w-20 bg-slate-50 dark:bg-app-side rounded-lg mr-1 flex flex-col items-center justify-start pt-3 border border-slate-100 dark:border-app-border flex-shrink-0">
                                            <span class="text-[9px] font-bold text-slate-400 dark:text-app-muted uppercase mb-0.5 tracking-wider">START</span>
                                            <span class="font-mono font-bold text-xl text-slate-700 dark:text-white tracking-tighter">${site.time}</span>
                                        </div>
                                        <div class="flex-grow flex flex-col pl-2 pt-1 pb-2 relative min-w-0">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="text-[10px] font-bold text-blue-600 dark:text-app-accent bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded border border-blue-100 dark:border-blue-800/50">
                                                    ${site.workDetail||'詳細なし'}
                                                </span>
                                            </div>
                                            <div class="mb-1 clickable" onclick="window.toggleLocation(this)">
                                                <h3 class="font-bold text-sm text-slate-800 dark:text-white leading-snug text-truncate-custom hover:text-blue-600 dark:hover:text-app-accent transition-colors">
                                                    ${site.placeName || '<span class="text-slate-400 font-normal italic">ロケーションなし</span>'}
                                                </h3>
                                                <div class="flex items-center mt-1">
                                                    <span class="text-[10px] text-slate-500 dark:text-app-muted">
                                                        <i class="fas fa-road text-emerald-500 dark:text-app-green mr-1"></i>${site.roadName ? site.roadName + ' 付近' : '道路名なし'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <a href="${mapUrl}" ${(!isAndroid && !isIOS) ? 'target="_blank"' : ''} class="flex-grow flex items-center gap-3 bg-slate-50 dark:bg-app-input p-2.5 rounded-lg border border-slate-100 dark:border-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors group/addr h-[50px]">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 dark:bg-app-accent/10 text-blue-500 dark:text-app-accent flex items-center justify-center flex-shrink-0">
                                            <i class="fas fa-map-marker-alt text-[10px]"></i>
                                        </div>
                                        <div class="min-w-0">
                                            <p class="text-[10px] text-slate-400 dark:text-app-muted font-mono leading-none mb-0.5">${site.address ? site.address.match(/〒\d{3}-\d{4}/) : ''}</p>
                                            <p class="text-xs font-bold text-slate-700 dark:text-slate-300 group-hover/addr:text-blue-600 dark:group-hover/addr:text-white leading-tight truncate">
                                                ${site.address ? site.address.replace(/〒\d{3}-\d{4}/,'').trim() : (site.lat ? '座標記録済み' : '住所情報なし')}
                                            </p>
                                        </div>
                                        <div class="ml-auto text-slate-400 dark:text-app-muted group-hover/addr:text-blue-500 dark:group-hover/addr:text-white">
                                            <i class="fas fa-external-link-alt text-[10px]"></i>
                                        </div>
                                    </a>
                                </div>
                                <div class="w-12 flex flex-col gap-1 flex-shrink-0">
                                    <button data-action="edit-site" data-index="${i}" class="flex-1 bg-slate-50 dark:bg-app-input rounded-lg border border-slate-100 dark:border-slate-700/50 flex items-center justify-center text-slate-400 dark:text-app-muted hover:text-blue-500 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                                        <i class="fas fa-pen text-sm"></i>
                                    </button>
                                    <button data-action="share-site" data-index="${i}" class="flex-1 bg-slate-50 dark:bg-app-input rounded-lg border border-slate-100 dark:border-slate-700/50 flex items-center justify-center text-slate-400 dark:text-app-muted hover:text-green-500 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                                        <i class="fas fa-share-alt text-sm"></i>
                                    </button>
                                    <button onclick="window.toggleNote(this)" class="clickable flex-1 bg-slate-50 dark:bg-app-input rounded-lg border border-slate-100 dark:border-slate-700/50 flex items-center justify-center text-slate-400 dark:text-app-muted hover:text-amber-500 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors relative group/btn">
                                        <i class="fas fa-sticky-note text-lg ${hasNote ? 'text-amber-500' : ''} group-hover/btn:scale-110 transition-transform"></i>
                                        ${hasNote ? `<span class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-amber-500 dark:bg-app-accent rounded-full border border-white dark:border-app-input"></span>` : ''}
                                    </button>
                                </div>
                            </div>
                            <!-- Note Section Fix -->
                            <div class="note-content px-1 overflow-hidden transition-all duration-300 max-h-0 opacity-0">
                                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-3 text-xs text-slate-600 dark:text-app-muted leading-relaxed whitespace-pre-wrap mt-1 border border-slate-100 dark:border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-1 opacity-50"><i class="fas fa-info-circle"></i><span class="text-[10px] font-bold uppercase tracking-wider">備考</span></div>
                                    ${site.notes||'備考なし'}
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }
            } catch(e) { Logger.add('CRITICAL', 'Render', e.message); }
        },

        openModal: (html) => { DOM.modal.body.innerHTML = html; DOM.backdrops.modal.classList.add('active'); DOM.modal.container.classList.add('active'); document.body.style.overflow = 'hidden'; },
        closeModal: () => { DOM.backdrops.modal.classList.remove('active'); DOM.modal.container.classList.remove('active'); DOM.modal.container.style.transform = ''; document.body.style.overflow = ''; },
        openFull: (html) => { DOM.fullScreen.innerHTML = html; requestAnimationFrame(() => DOM.fullScreen.classList.add('active')); document.body.style.overflow = 'hidden'; },
        closeFull: () => { DOM.fullScreen.classList.remove('active'); document.body.style.overflow = ''; if(window.locationWatchId){navigator.geolocation.clearWatch(window.locationWatchId); window.locationWatchId=null;} },
        openGeneralFull: (html) => { DOM.generalFullScreen.innerHTML = html; requestAnimationFrame(() => DOM.generalFullScreen.classList.add('active')); document.body.style.overflow = 'hidden'; },
        closeGeneralFull: () => { DOM.generalFullScreen.classList.remove('active'); document.body.style.overflow = ''; },
        
        openConfirm: (msg, onYes) => {
            DOM.dialog.content.innerHTML = `<div class="text-center"><i class="fas fa-question-circle text-4xl text-blue-500 mb-4 opacity-80"></i><p class="text-sm font-bold text-slate-800 dark:text-white mb-6">${msg}</p><div class="flex gap-3"><button id="dlg-no" class="flex-1 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-bold">キャンセル</button><button id="dlg-yes" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg text-xs font-bold shadow-lg">実行する</button></div></div>`;
            DOM.backdrops.dialog.classList.remove('hidden'); setTimeout(()=>DOM.backdrops.dialog.classList.add('active'),10);
            document.getElementById('dlg-yes').onclick = () => { onYes(); UI.closeDialog(); }; document.getElementById('dlg-no').onclick = UI.closeDialog;
        },
        openPrompt: (title, val, onOk) => {
             DOM.dialog.content.innerHTML = `<div class="text-center"><p class="text-sm font-bold text-slate-800 dark:text-white mb-4">${title}</p><input id="dlg-in" class="modern-input w-full p-3 mb-6 text-sm" value="${val}" placeholder="入力..."><div class="flex gap-3"><button id="dlg-cancel" class="flex-1 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-bold">キャンセル</button><button id="dlg-ok" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg text-xs font-bold shadow-lg">OK</button></div></div>`;
            DOM.backdrops.dialog.classList.remove('hidden'); setTimeout(()=>DOM.backdrops.dialog.classList.add('active'),10);
            const inp = document.getElementById('dlg-in'); inp.focus();
            document.getElementById('dlg-ok').onclick = () => { if(inp.value.trim()){ onOk(inp.value.trim()); UI.closeDialog(); }}; document.getElementById('dlg-cancel').onclick = UI.closeDialog;
        },
        closeDialog: () => { DOM.backdrops.dialog.classList.remove('active'); setTimeout(() => DOM.backdrops.dialog.classList.add('hidden'), 300); }
    };

    // --- GLOBAL FUNCTIONS ---
    window.toggleLocation = (el) => {
        const h3=el.querySelector('h3'), icon=el.querySelector('.fa-chevron-down');
        if(h3.classList.contains('text-truncate-custom')) { h3.classList.remove('text-truncate-custom'); h3.classList.add('text-expanded'); if(icon)icon.classList.add('rotate-180'); } 
        else { h3.classList.add('text-truncate-custom'); h3.classList.remove('text-expanded'); if(icon)icon.classList.remove('rotate-180'); }
    };
    
    window.toggleNote = (btn) => {
        let container = btn.closest('.bg-white, .dark\\:bg-app-card') || btn.closest('.group');
        let content = container.querySelector('.note-content'), icon = btn.querySelector('i');
        // Toggle Logic Fix
        if(content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            content.style.maxHeight = '0'; content.style.opacity = '0';
            btn.classList.remove('bg-slate-100','dark:bg-slate-700/50','text-amber-500','dark:text-white'); 
            if(!btn.querySelector('.absolute')&&icon.classList.contains('fas')) {icon.classList.remove('fas');icon.classList.add('far');}
        } else {
            content.classList.add('expanded');
            content.style.maxHeight = '500px'; content.style.opacity = '1';
            btn.classList.add('bg-slate-100','dark:bg-slate-700/50','text-amber-500','dark:text-white'); 
            if(icon.classList.contains('far')) {icon.classList.remove('far');icon.classList.add('fas');}
        }
    };

    window.setupDropdown = (cat, val, idPrefix) => { 
        const con = document.getElementById((idPrefix||cat)+'-con'); const hidden = document.getElementById((idPrefix||cat)+'-val'); 
        function render(pId, depth, path) { 
            const kids = STATE.labelTrees[cat].filter(n => n.parentId === pId); 
            if (depth > 0 && kids.length === 0 && depth > path.length) return; 
            const sel = document.createElement('select'); sel.className = 'modern-input w-full p-2.5 mb-2 text-sm bg-[right_0.8rem_center] h-[42px]'; 
            sel.innerHTML = `<option value="">${depth===0?'選択してください':'詳細を選択'}</option>`; kids.forEach(k => sel.innerHTML += `<option value="${k.id}">${k.name}</option>`); sel.innerHTML += `<option value="other">その他</option>`; 
            con.appendChild(sel); 
            if (depth < path.length) { 
                const f = kids.find(k => k.name === path[depth]); 
                if(f) { sel.value = f.id; render(f.id, depth+1, path); } 
                else { sel.value='other'; const inp=document.createElement('input'); inp.className='modern-input w-full p-2.5 mt-1 text-sm'; inp.value=path.slice(depth).join(' / '); inp.oninput=update; con.appendChild(inp); } 
            } 
            sel.onchange = () => { 
                while(sel.nextSibling) con.removeChild(sel.nextSibling); 
                if(sel.value==='other'){const inp=document.createElement('input');inp.className='modern-input w-full p-2.5 mt-1 text-sm';inp.placeholder='内容を入力';inp.focus();inp.oninput=update;con.appendChild(inp);}
                else if(sel.value){render(parseInt(sel.value),depth+1,[]);} update(); 
            } 
        } 
        function update() { 
            const p=[]; con.querySelectorAll('select').forEach(s=>{if(s.value&&s.value!=='other')p.push(s.options[s.selectedIndex].text);}); 
            const inp=con.querySelector('input'); if(inp&&inp.value.trim())p.push(inp.value.trim()); hidden.value=p.join(' / '); 
        } 
        con.innerHTML=''; render(null,0,val?val.split(' / '):[]); hidden.value=val||''; 
    };

    window.showDailyInfoModal = () => {
        const di = Utils.getTodayData().dailyInfo;
        const grp = (l,id) => `<div class="mb-4"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">${l}</label><div id="${id}-con"></div><input type="hidden" id="${id}-val"></div>`;
        UI.openModal(`<h3 class="text-lg font-bold text-slate-800 dark:text-white mb-6 px-1">業務情報の編集</h3><div class="space-y-1">${grp('会社名','company')} ${grp('仕事の種類','jobType')} ${grp('班名','teamName')}<div class="mb-4"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">工事名</label><input id="proj-in" class="modern-input w-full p-3 text-sm" value="${di.projectName||''}"></div><div class="mb-6"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">備考</label><textarea id="note-in" class="modern-input w-full p-3 h-24 text-sm resize-none">${di.notes||''}</textarea></div><div class="flex gap-3"><button onclick="UI.closeModal()" class="flex-1 py-3.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-xl font-bold text-sm">キャンセル</button><button data-action="save-daily-info" class="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 text-sm">保存</button></div></div>`);
        window.setupDropdown('company', di.company); window.setupDropdown('jobType', di.jobType); window.setupDropdown('teamName', di.teamName);
    };

    window.showLabelManagementModal = () => {
        UI.openModal(`<h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 px-1">ラベル管理</h3><select id="l-cat" class="modern-input w-full p-3 text-sm mb-4"><option value="company">会社名</option><option value="jobType">仕事の種類</option><option value="teamName">班名</option><option value="workDetail">作業内容</option></select><div id="l-tree" class="max-h-60 overflow-y-auto bg-slate-50 dark:bg-slate-800/50 rounded-xl p-2 mb-4 space-y-2"></div><button id="add-r" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-xs shadow-lg mb-2">＋ 親ラベル追加</button><button onclick="UI.closeModal()" class="w-full py-3 bg-slate-100 dark:bg-slate-800 rounded-xl font-bold text-xs">完了</button>`);
        const sel=document.getElementById('l-cat'), tree=document.getElementById('l-tree');
        const ren=()=>{ const c=sel.value, roots=STATE.labelTrees[c].filter(n=>!n.parentId); tree.innerHTML=''; const nUI=(n,d)=>{const el=document.createElement('div');el.className=`flex justify-between items-center p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 ml-${d*4}`;el.style.marginLeft=(d*12)+'px';el.innerHTML=`<span class="text-xs font-bold text-slate-700 dark:text-slate-300">${n.name}</span><div class="flex gap-2"><button class="text-emerald-500" onclick="window.addLChild(${n.id})"><i class="fas fa-plus"></i></button><button class="text-red-400" onclick="window.delLNode(${n.id})"><i class="fas fa-trash"></i></button></div>`;tree.appendChild(el);STATE.labelTrees[c].filter(k=>k.parentId===n.id).forEach(k=>nUI(k,d+1));}; if(roots.length)roots.forEach(n=>nUI(n,0));else tree.innerHTML='<p class="text-center text-xs text-slate-400 py-4">なし</p>'; };
        sel.onchange=ren; ren();
        document.getElementById('add-r').onclick=()=>{UI.closeModal();setTimeout(()=>UI.openPrompt('親ラベル名','',n=>{STATE.labelTrees[sel.value].push({id:STATE.nextLabelId++,name:n,parentId:null});Storage.saveLabels();showLabelManagementModal();}),300);};
    };
    
    window.addLChild=(id)=>{UI.closeModal();setTimeout(()=>UI.openPrompt('子ラベル名','',n=>{STATE.labelTrees[document.getElementById('l-cat').value].push({id:STATE.nextLabelId++,name:n,parentId:id});Storage.saveLabels();showLabelManagementModal();}),300);};
    window.delLNode=(id)=>{UI.closeModal();setTimeout(()=>UI.openConfirm('削除しますか？',()=>{const cat=document.getElementById('l-cat').value;const rm=(nid)=>{STATE.labelTrees[cat].filter(x=>x.parentId===nid).forEach(x=>rm(x.id));STATE.labelTrees[cat]=STATE.labelTrees[cat].filter(x=>x.id!==nid);};rm(id);Storage.saveLabels();showLabelManagementModal();}),300);};

    window.Calendar = {
        render: (animClass) => {
            const container = document.getElementById('cal-container'); if (!container) return;
            const y = STATE.calendarDate.getFullYear(), m = STATE.calendarDate.getMonth();
            let html = `<div class="flex justify-between items-center mb-4 px-2"><button onclick="Handlers.calMove(-1)" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center active:bg-slate-200 dark:active:bg-slate-700 transition-colors"><i class="fas fa-chevron-left"></i></button><button onclick="Handlers.calToggleView()" class="text-xl font-bold text-slate-800 dark:text-white px-4 py-2 rounded-xl active:bg-slate-100 dark:active:bg-slate-800 transition-colors flex items-center">${STATE.calendarView === 'day' ? `${y}年 ${m+1}月 <i class="fas fa-caret-down ml-2 text-sm opacity-50"></i>` : STATE.calendarView === 'year' ? '年を選択' : '月を選択'}</button><button onclick="Handlers.calMove(1)" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center active:bg-slate-200 dark:active:bg-slate-700 transition-colors"><i class="fas fa-chevron-right"></i></button></div>`;
            if (STATE.calendarView === 'day') {
                const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate(), today = Utils.formatKey(new Date()), current = Utils.formatKey(STATE.currentDate);
                let grid = `<div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-400 mb-2"><div class="text-red-400">日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div class="text-blue-400">土</div></div><div class="grid grid-cols-7 gap-1 auto-rows-fr h-64">`;
                for(let i=0; i<first; i++) grid += `<div></div>`;
                for(let d=1; d<=days; d++) { const k = Utils.formatKey(new Date(y, m, d)); let c = 'calendar-day cursor-pointer active:bg-slate-100 dark:active:bg-slate-800 text-slate-700 dark:text-slate-300'; if(STATE.allData[k]&&(STATE.allData[k].sites.length>0||STATE.allData[k].dailyInfo.company))c+=' has-record'; if(k===today)c+=' is-today'; if(k===current)c+=' is-selected'; grid += `<div onclick="Handlers.calSelect('${k}')" class="${c}">${d}</div>`; }
                html += `<div class="${animClass||''}">${grid}</div></div>`;
            } else if (STATE.calendarView === 'year') {
                let years = `<div class="grid grid-cols-4 gap-4 h-72 overflow-y-auto animate-fade-in content-start">`;
                for(let i=y-10; i<=y+10; i++) years += `<div onclick="Handlers.calSelectYear(${i})" class="p-3 rounded-xl text-center font-bold text-sm cursor-pointer ${i===y?"bg-blue-600 text-white":"text-slate-700 dark:text-slate-300 active:bg-slate-100 dark:active:bg-slate-800"}">${i}</div>`;
                html += years + `</div>`;
            } else {
                let months = `<div class="grid grid-cols-3 gap-4 h-72 animate-fade-in content-center">`;
                for(let i=0; i<12; i++) months += `<div onclick="Handlers.calSelectMonth(${i})" class="p-4 rounded-xl text-center font-bold cursor-pointer ${i===m?"bg-blue-600 text-white":"text-slate-700 dark:text-slate-300 active:bg-slate-100 dark:active:bg-slate-800"}">${i+1}月</div>`;
                html += months + `</div>`;
            }
            container.innerHTML = html;
            if(STATE.calendarView === 'day') {
                const el = container.lastElementChild; let sx = 0;
                el.addEventListener('touchstart', e => sx = e.touches[0].clientX, {passive:true});
                el.addEventListener('touchend', e => { if (Math.abs(e.changedTouches[0].clientX - sx) > 50) Handlers.calMove(e.changedTouches[0].clientX - sx > 0 ? -1 : 1); }, {passive:true});
            }
        },
        show: () => { STATE.calendarView = 'day'; STATE.calendarDate = new Date(STATE.currentDate); UI.openModal(`<div id="cal-container" class="min-h-[350px]"></div><button onclick="Handlers.goToday()" class="w-full py-3 mt-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-xl font-bold text-sm active:bg-slate-200 dark:active:bg-slate-700 transition-colors">今日に戻る</button>`); window.Calendar.render(); }
    };

    window.Handlers = {
        prevDay: () => { STATE.currentDate.setDate(STATE.currentDate.getDate()-1); UI.renderPage(); },
        nextDay: () => { STATE.currentDate.setDate(STATE.currentDate.getDate()+1); UI.renderPage(); },
        goToday: () => { STATE.currentDate = new Date(); UI.renderPage(); UI.closeModal(); },
        
        showSecureSettings: () => {
            const html = `
                <div class="bg-white dark:bg-slate-900 h-full flex flex-col">
                    <div class="header-glass px-4 py-3 flex items-center justify-between z-10 flex-shrink-0">
                        <button onclick="UI.closeGeneralFull()" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-slate-100 dark:active:bg-slate-800 text-slate-500 dark:text-slate-300"><i class="fas fa-chevron-left text-lg"></i></button>
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white">接続情報・AI設定</h2>
                        <div class="w-10"></div>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 space-y-6">
                        <div class="modern-card p-4 bg-white dark:bg-app-card">
                            <h3 class="text-xs font-bold text-slate-400 dark:text-app-muted uppercase tracking-wider mb-3"><i class="fas fa-map-marked-alt mr-1"></i>Google Maps API</h3>
                            <div class="relative">
                                <input id="key-maps" type="password" class="modern-input w-full p-3 pr-10 text-sm font-mono bg-slate-50 dark:bg-app-input" value="${STATE.secrets.googleMapsKey}" placeholder="API Key">
                                <button onclick="Handlers.togglePass('key-maps', this)" class="absolute right-2 top-2 w-8 h-8 flex items-center justify-center text-slate-400 active:text-blue-500"><i class="fas fa-eye"></i></button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2">※地図表示と住所検索に使用します。</p>
                        </div>
                        <div class="modern-card p-4 bg-white dark:bg-app-card border-t-4 border-t-purple-500">
                            <h3 class="text-xs font-bold text-purple-500 uppercase tracking-wider mb-3 flex items-center justify-between">
                                <span><i class="fas fa-robot mr-1"></i>AIパートナー (Gemini)</span>
                                <span class="badge-pro bg-purple-500 text-white">BETA</span>
                            </h3>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">API Key</label>
                            <div class="relative mb-4">
                                <input id="key-gemini" type="password" class="modern-input w-full p-3 pr-10 text-sm font-mono bg-slate-50 dark:bg-app-input" value="${STATE.secrets.geminiKey}" placeholder="Gemini API Key">
                                <button onclick="Handlers.togglePass('key-gemini', this)" class="absolute right-2 top-2 w-8 h-8 flex items-center justify-center text-slate-400 active:text-blue-500"><i class="fas fa-eye"></i></button>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Model</label><select id="sel-model" class="modern-input w-full p-2 text-xs"><option value="gemini-1.5-flash">1.5 Flash (Std)</option><option value="gemini-2.0-flash">2.0 Flash (New)</option><option value="gemini-3.0-flash-preview">3.0 Flash (Preview)</option></select></div>
                                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Persona</label><select id="sel-persona" class="modern-input w-full p-2 text-xs"><option value="app-default">アプリ専用AI</option><option value="vanilla">素のAI</option><option value="custom">カスタム (上級)</option></select></div>
                            </div>
                            <p class="text-[10px] text-slate-400">※現在AI機能は準備中です。</p>
                        </div>
                        <button onclick="Handlers.saveSecureSettings()" class="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 text-sm active:scale-95 transition-transform">設定を保存する</button>
                    </div>
                </div>
            `;
            UI.openGeneralFull(html);
            setTimeout(() => { document.getElementById('sel-model').value = STATE.secrets.aiModel; document.getElementById('sel-persona').value = STATE.secrets.aiPersona; }, 50);
        },
        togglePass: (id, btn) => { const inp = document.getElementById(id); const isPass = inp.type === 'password'; inp.type = isPass ? 'text' : 'password'; btn.innerHTML = `<i class="fas fa-eye${isPass ? '-slash' : ''}"></i>`; btn.classList.toggle('text-blue-500', isPass); },
        saveSecureSettings: () => {
            STATE.secrets.googleMapsKey = document.getElementById('key-maps').value.trim();
            STATE.secrets.geminiKey = document.getElementById('key-gemini').value.trim();
            STATE.secrets.aiModel = document.getElementById('sel-model').value;
            STATE.secrets.aiPersona = document.getElementById('sel-persona').value;
            Storage.saveSecrets();
            if (STATE.secrets.googleMapsKey && !window.google) setTimeout(() => window.location.reload(), 1000);
            Utils.showToast('設定を保存しました'); UI.closeGeneralFull();
        },

        showDebug: () => {
            const txt = Logger.exportText();
            const status = Logger.hasCriticalError 
                ? `<div class="mb-4 bg-red-100 dark:bg-red-900/30 p-3 rounded-xl border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 text-xs font-bold flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-lg"></i>エラーが検出されています。ログを確認してください。</div>`
                : `<div class="mb-4 bg-green-100 dark:bg-green-900/30 p-3 rounded-xl border border-green-200 dark:border-green-800 text-green-600 dark:text-green-400 text-xs font-bold flex items-center"><i class="fas fa-check-circle mr-2 text-lg"></i>現在、重大なエラーは検出されていません。</div>`;
            
            const html = `
                <div class="bg-white dark:bg-slate-900 h-full flex flex-col">
                    <div class="header-glass px-4 py-3 flex items-center justify-between z-10 flex-shrink-0">
                        <button onclick="UI.closeGeneralFull()" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-slate-100 dark:active:bg-slate-800 text-slate-500 dark:text-slate-300"><i class="fas fa-chevron-left text-lg"></i></button>
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white">不具合報告・ログ</h2>
                        <div class="w-10"></div>
                    </div>
                    <div class="flex-grow overflow-hidden flex flex-col p-4">
                        ${status}
                        <div class="bg-slate-900 text-green-400 p-3 rounded-xl font-mono text-xs overflow-auto flex-grow mb-4 border border-slate-700 shadow-inner whitespace-pre leading-relaxed select-text" id="log-display">${txt}</div>
                        <div class="flex gap-3 flex-shrink-0">
                            <button onclick="Handlers.copyLog()" class="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-white rounded-xl font-bold text-sm border border-slate-200 dark:border-slate-700"><i class="fas fa-copy mr-2"></i>コピー</button>
                            <button onclick="Utils.downloadFile('TrafficGuard_Log.txt', Logger.exportText())" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg"><i class="fas fa-file-export mr-2"></i>ファイル出力</button>
                        </div>
                    </div>
                </div>
            `;
            UI.openGeneralFull(html);
        },
        copyLog: () => { Utils.copyToClipboard(Logger.exportText()); },
        copyLastError: () => { Utils.copyToClipboard(Logger.exportText()); Utils.hideErrorToast(); },

        showHistory: () => {
            const html = `
                <div class="bg-white dark:bg-slate-900 h-full flex flex-col">
                    <div class="header-glass px-4 py-3 flex items-center justify-between z-10 flex-shrink-0">
                        <button onclick="UI.closeGeneralFull()" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-slate-100 dark:active:bg-slate-800 text-slate-500 dark:text-slate-300"><i class="fas fa-chevron-left text-lg"></i></button>
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white">更新履歴</h2>
                        <div class="w-10"></div>
                    </div>
                    <div class="flex-grow overflow-y-auto p-6">
                        ${CHANGELOG.map(item => `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="mb-1"><span class="text-lg font-bold text-slate-800 dark:text-white mr-2">${item.version}</span><span class="text-xs text-slate-400">${item.date}</span></div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700"><p class="text-xs font-bold text-blue-500 dark:text-blue-400 mb-2 uppercase tracking-wider">${item.title}</p><p class="text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">${item.desc}</p><ul class="list-disc list-inside text-sm text-slate-600 dark:text-slate-400 space-y-1">${item.details.map(d => `<li>${d}</li>`).join('')}</ul></div>
                        </div>`).join('')}
                    </div>
                </div>
            `;
            UI.openGeneralFull(html);
        },

        openSiteRecord: async (data, idx) => {
            const isNew = !data;
            const d = data || { time: new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}), workDetail:'', notes:'', address:'', placeName:'', roadName:'' };
            const {postal, addr} = Utils.parseAddress(d.address);
            const safeIdx = idx !== null ? idx : 'null';
            const html = `
                <div class="bg-white dark:bg-slate-900 h-full flex flex-col">
                    <div class="header-glass px-4 py-3 flex items-center justify-between z-10 flex-shrink-0">
                        <button onclick="UI.closeFull()" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-slate-100 dark:active:bg-slate-800 text-slate-500 dark:text-slate-300"><i class="fas fa-chevron-left text-lg"></i></button>
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white">現場記録</h2>
                        <div class="w-10"></div>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 space-y-4">
                        <div id="map-area" class="w-full h-48 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center border border-slate-200 dark:border-slate-700 relative overflow-hidden text-xs text-slate-400">${STATE.secrets.googleMapsKey ? '<i class="fas fa-spinner fa-spin mr-2"></i>地図読み込み中...' : '<i class="fas fa-exclamation-triangle mr-1"></i>APIキー未設定'}</div>
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 pl-1">住所</label><input id="addr-in" class="modern-input w-full p-3 text-sm" value="${addr}" placeholder="住所"></div>
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-4"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 pl-1">郵便番号</label><input id="zip-in" class="modern-input w-full p-3 text-sm" value="${postal}" placeholder="000-0000"></div>
                            <div class="col-span-8"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 pl-1">ロケーション</label><input id="place-name-in" class="modern-input w-full p-3 text-sm font-bold text-slate-700 dark:text-slate-200" value="${d.placeName || ''}" placeholder="施設・店名"></div>
                        </div>
                        <div class="flex gap-3">
                            <div class="flex-grow"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 pl-1">付近の道路</label><input id="road-name-in" class="modern-input w-full p-2.5 h-[46px] text-sm text-slate-700 dark:text-slate-200" value="${d.roadName || ''}" placeholder="道路名"></div>
                            <div class="w-22 flex-shrink-0"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 pl-1">時間</label><input id="time-in" type="time" class="modern-input w-full p-2.5 text-left font-mono text-lg tracking-wider bg-slate-50 dark:bg-slate-800 h-[46px]" value="${d.time}"></div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 pl-1">作業内容</label>
                            <button id="wd-btn" onclick="Handlers.openWorkDetailPicker()" class="modern-input w-full p-3 text-left flex justify-between items-center bg-white dark:bg-slate-800 active:bg-slate-50 dark:active:bg-slate-700">
                                <span id="wd-display" class="font-bold text-slate-700 dark:text-slate-200 text-sm">${d.workDetail || '<span class="text-slate-400 font-normal">タップして選択</span>'}</span>
                                <i class="fas fa-chevron-right text-slate-400 text-xs"></i>
                            </button>
                            <input type="hidden" id="wd-val" value="${d.workDetail||''}">
                        </div>
                        <details class="group modern-card border-none shadow-none bg-slate-50 dark:bg-slate-800/50">
                            <summary class="flex justify-between items-center font-bold p-3 text-sm text-slate-500 dark:text-slate-400 select-none"><span>備考</span><i class="fas fa-chevron-down arrow-icon transition-transform duration-200"></i></summary>
                            <div class="px-3 pb-3"><textarea id="s-note-in" class="modern-input w-full p-3 h-24 text-sm resize-none bg-white dark:bg-slate-800" placeholder="メモを入力...">${d.notes||''}</textarea></div>
                        </details>
                        <div class="h-20"></div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent dark:from-slate-900 dark:via-slate-900 z-20 safe-area-bottom">
                        <div class="flex gap-3">
                            ${!isNew ? `<button onclick="Handlers.deleteSite(${safeIdx})" class="px-4 py-3.5 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold text-sm"><i class="fas fa-trash"></i></button>` : ''}
                            <button onclick="Handlers.saveSite(${safeIdx})" class="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 text-sm active:scale-95 transition-transform">保存する</button>
                        </div>
                    </div>
                </div>
            `;
            UI.openFull(html);
            
            const zIn=document.getElementById('zip-in'), aIn=document.getElementById('addr-in'), pIn=document.getElementById('place-name-in'), rIn=document.getElementById('road-name-in');
            let geocoder, placesService; window.currentMarker = null; window.userLocationMarker = null;
            if(STATE.secrets.googleMapsKey && window.google && window.google.maps) geocoder = new google.maps.Geocoder();

            aIn.addEventListener('blur',()=>{
                if(aIn.value && geocoder) geocoder.geocode({address:aIn.value}, (results, status) => { if(status === 'OK' && results[0]) { const p = Utils.parseAddress(results[0].formatted_address.replace('日本、','')); zIn.value = p.postal; aIn.value = p.addr; if (window.currentMarker) { window.currentMarker.setPosition(results[0].geometry.location); window.currentMarker.getMap().setCenter(results[0].geometry.location); } } });
            });
            const initMap = (lat, lng) => {
                const mDiv=document.getElementById('map-area'); if(!mDiv) return; mDiv.innerHTML='';
                const map=new google.maps.Map(mDiv,{center:{lat,lng},zoom:17,disableDefaultUI:true});
                window.currentMarker = new google.maps.Marker({position:{lat,lng},map,draggable:true});
                if (navigator.geolocation) window.locationWatchId = navigator.geolocation.watchPosition((pos) => { const userLatLng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude); if (!window.userLocationMarker) window.userLocationMarker = new google.maps.Marker({ position: userLatLng, map: map, zIndex: 999, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 } }); else window.userLocationMarker.setPosition(userLatLng); }, null, { enableHighAccuracy: true });
                placesService = new google.maps.places.PlacesService(map);
                const updateLoc = (lt, lg) => {
                    geocoder.geocode({ location: { lat: lt, lng: lg } }, (results, status) => { if (status === 'OK' && results[0]) { const full = results[0].formatted_address.replace('日本、', '').trim(); const p = Utils.parseAddress(full); zIn.value = p.postal; aIn.value = p.addr; } });
                    placesService.nearbySearch({ location: { lat: lt, lng: lg }, radius: 40 }, (results, status) => { let foundPlace = '', foundRoad = ''; if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) { const road = results.find(r => r.types.includes('route')); if (road) foundRoad = road.name; const place = results.find(r => !r.types.includes('route') && !r.types.includes('political') && (r.types.includes('point_of_interest') || r.types.includes('establishment'))); if (place) foundPlace = place.name; } pIn.value = foundPlace; rIn.value = foundRoad; });
                };
                window.currentMarker.addListener('dragend',e=>updateLoc(e.latLng.lat(),e.latLng.lng()));
            };
            if(STATE.secrets.googleMapsKey && window.google) {
                if (d && d.lat && d.lng) initMap(d.lat, d.lng);
                else if (isNew) navigator.geolocation.getCurrentPosition(pos=>{ initMap(pos.coords.latitude, pos.coords.longitude); const geocoder = new google.maps.Geocoder(); geocoder.geocode({ location: { lat: pos.coords.latitude, lng: pos.coords.longitude } }, (results, status) => { if(status==='OK' && results[0]) { const p=Utils.parseAddress(results[0].formatted_address.replace('日本、','')); zIn.value=p.postal; aIn.value=p.addr; } }); },()=>document.getElementById('map-area').innerHTML='<span class="text-red-400">位置情報エラー</span>',{enableHighAccuracy:true});
                else if (d.address) geocoder.geocode({address: d.address}, (results, status) => { if(status === 'OK' && results[0]) initMap(results[0].geometry.location.lat(), results[0].geometry.location.lng()); else document.getElementById('map-area').innerHTML='<span class="text-slate-400">地図情報なし</span>'; });
                else document.getElementById('map-area').innerHTML='<span class="text-slate-400">地図情報なし</span>';
            } else if(!STATE.secrets.googleMapsKey) document.getElementById('map-area').innerHTML='<span class="text-amber-500 font-bold">設定からAPIキーを入力してください</span>';
        },
        openWorkDetailPicker: () => { window.Handlers.nextPickerStep(null, 0, []); },
        nextPickerStep: (pId, depth, path) => {
            const cat = 'workDetail'; const kids = STATE.labelTrees[cat].filter(n => n.parentId === pId);
            let h = `<div class="p-4"><h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">${depth===0 ? '作業内容を選択' : path[path.length-1]}</h3>`;
            if (depth > 0) h += `<button onclick="Handlers.pickWorkDetail('${path.join(' / ')}')" class="w-full text-left p-3 mb-2 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-bold border border-blue-200 dark:border-blue-800"><i class="fas fa-check mr-2"></i>「${path.join(' / ')}」で確定</button><div class="border-b border-slate-100 dark:border-slate-800 my-2"></div>`;
            if (kids.length === 0) h += `<p class="text-slate-400 text-sm text-center py-4">詳細なし</p>`;
            else kids.forEach(k => { h += `<button onclick='Handlers.nextPickerStep(${k.id}, ${depth+1}, ${JSON.stringify([...path, k.name])})' class="w-full text-left p-3 mb-2 rounded-xl bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-medium flex justify-between items-center active:bg-slate-200 dark:active:bg-slate-700"><span>${k.name}</span><i class="fas fa-chevron-right text-slate-400 text-xs"></i></button>`; });
            h += `<div class="border-t border-slate-100 dark:border-slate-800 mt-2 pt-2"><p class="text-xs text-slate-400 mb-1">または手入力</p><div class="flex gap-2"><input id="pk-custom" class="modern-input flex-1 p-2 text-sm" placeholder="自由入力"><button onclick="Handlers.pickWorkDetail(document.getElementById('pk-custom').value)" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-lg text-xs font-bold">決定</button></div></div></div>`;
            UI.openModal(h);
        },
        pickWorkDetail: (val) => { if(!val)return; const d=document.getElementById('wd-display'),h=document.getElementById('wd-val'); if(d&&h){d.innerText=val;d.classList.remove('text-slate-400','font-normal');h.value=val;} UI.closeModal(); },
        saveDailyInfo: () => { const data = Utils.getTodayData(); data.dailyInfo = { company: document.getElementById('company-val').value, jobType: document.getElementById('jobType-val').value, teamName: document.getElementById('teamName-val').value, projectName: document.getElementById('proj-in').value, notes: document.getElementById('note-in').value }; Storage.save(); UI.renderPage(); UI.closeModal(); Utils.showToast('保存しました'); },
        saveSite: (index) => { try { const data = Utils.getTodayData(); const postal=document.getElementById('zip-in').value, addr=document.getElementById('addr-in').value, place=document.getElementById('place-name-in').value, road=document.getElementById('road-name-in').value; let lat=null, lng=null; if (window.currentMarker && typeof window.currentMarker.getPosition === 'function') { lat = window.currentMarker.getPosition().lat(); lng = window.currentMarker.getPosition().lng(); } else if (index !== null && data.sites[index].lat) { lat = data.sites[index].lat; lng = data.sites[index].lng; } const site = { time: document.getElementById('time-in').value, workDetail: document.getElementById('wd-val').value, notes: document.getElementById('s-note-in').value, address: postal?`〒${postal} ${addr}`:addr, mapLink: '', placeName: place, roadName: road, lat: lat, lng: lng }; if (index === null) data.sites.push(site); else data.sites[index] = site; data.sites.sort((a,b) => a.time.localeCompare(b.time)); Storage.save(); UI.renderPage(); UI.closeFull(); Utils.showToast(index===null?'追加しました':'更新しました'); } catch(e) { Logger.add('ERROR','SaveSite',e.message); Utils.showToast('保存エラー','error'); } },
        deleteSite: (index) => { setTimeout(() => UI.openConfirm('削除しますか？', () => { Utils.getTodayData().sites.splice(index, 1); Storage.save(); UI.renderPage(); UI.closeFull(); Utils.showToast('削除しました'); }), 100); },
        shareSite: async (index) => { const site = Utils.getTodayData().sites[index]; if (!site) return; const lines = []; if (site.placeName) lines.push(site.placeName); if (site.address) lines.push(site.address); let url = (site.lat && site.lng) ? `https://www.google.com/maps/search/?api=1&query=${site.lat},${site.lng}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.address||site.placeName||'')}`; const shareData = { title: site.placeName || '現場記録', text: lines.join('\n'), url: url }; try { if (navigator.share && navigator.canShare(shareData)) await navigator.share(shareData); else throw new Error('Unsupported'); } catch { Utils.copyToClipboard(`${lines.join('\n')}\n${url}`); } },
        pwaGen: {
            manifest: () => { const m={name:"現場記録Pro",short_name:"現場記録",start_url:"./index.html",display:"standalone",background_color:"#f8fafc",theme_color:"#0b1121",orientation:"portrait",icons:[{src:"icon-192.png",sizes:"192x192",type:"image/png"}]}; Utils.downloadFile('manifest.json', JSON.stringify(m,null,2)); Utils.showToast('manifest.json保存'); },
            sw: () => { const s=`const C='tg-pro-v2.0.0_p1_6';const A=['./','./index.html','https://cdn.tailwindcss.com','https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'];self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(A))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`; Utils.downloadFile('service-worker.js', s.trim()); Utils.showToast('service-worker.js保存'); },
            icon: () => { const c=document.createElement('canvas');c.width=192;c.height=192;const x=c.getContext('2d');x.fillStyle='#0b1121';x.fillRect(0,0,192,192);x.fillStyle='#fff';x.font='bold 80px sans-serif';x.textAlign='center';x.textBaseline='middle';x.fillText('TG',96,96); const a=document.createElement('a');a.href=c.toDataURL('image/png');a.download='icon-192.png';a.click(); }
        },
        calMove: (dir) => { const anim = dir > 0 ? 'animate-slide-in-right' : 'animate-slide-in-left'; if (STATE.calendarView === 'day') STATE.calendarDate.setMonth(STATE.calendarDate.getMonth() + dir); else if (STATE.calendarView === 'year') STATE.calendarDate.setFullYear(STATE.calendarDate.getFullYear() + (dir*10)); else STATE.calendarDate.setFullYear(STATE.calendarDate.getFullYear() + dir); Calendar.render(anim); },
        calToggleView: () => { STATE.calendarView = STATE.calendarView === 'day' ? 'year' : 'day'; Calendar.render('animate-fade-in'); },
        calSelectYear: (y) => { STATE.calendarDate.setFullYear(y); STATE.calendarView = 'month'; Calendar.render('animate-fade-in'); },
        calSelectMonth: (m) => { STATE.calendarDate.setMonth(m); STATE.calendarView = 'day'; Calendar.render('animate-fade-in'); },
        calSelect: (dStr) => { STATE.currentDate = new Date(dStr); UI.renderPage(); UI.closeModal(); }
    };

    // --- Init ---
    window.onload = async () => {
        try {
            await window.Storage.init();
            window.UI.initTheme(); 
            window.UI.renderPage();
            
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(() => {});
            if(window.STATE.secrets.googleMapsKey) { const s = document.createElement('script'); s.src = `https://maps.googleapis.com/maps/api/js?key=${window.STATE.secrets.googleMapsKey}&libraries=places`; document.head.appendChild(s); }
            
            document.body.addEventListener('click', (e) => {
                try {
                    const target = e.target.closest('[data-action]'); if (!target) return;
                    const action = target.dataset.action; target.blur();
                    
                    if (action === 'toggle-menu') { DOM.sideMenu.classList.contains('active') ? UI.closeMenu() : UI.openMenu(); return; }
                    if (action === 'close-menu' || ['backup','restore','settings-labels','settings-secure','show-history','show-debug','show-about'].includes(action)) UI.closeMenu();

                    switch(action) {
                        case 'prev-day': Handlers.prevDay(); break;
                        case 'next-day': Handlers.nextDay(); break;
                        case 'show-calendar': Calendar.show(); break;
                        case 'edit-daily-info': window.showDailyInfoModal(); break;
                        case 'save-daily-info': Handlers.saveDailyInfo(); break;
                        case 'add-site': Handlers.openSiteRecord(null, null); break;
                        case 'edit-site': Handlers.openSiteRecord(Utils.getTodayData().sites[target.dataset.index], parseInt(target.dataset.index)); break;
                        case 'share-site': Handlers.shareSite(parseInt(target.dataset.index)); break;
                        case 'toggle-accordion': const c = document.getElementById(target.dataset.target); c.classList.toggle('hidden'); target.querySelector('.fa-chevron-down').classList.toggle('rotate-180'); break;
                        case 'backup': const b = JSON.stringify({dataType:'TrafficGuardProBackup', version:CONFIG.appVersion, allData:STATE.allData, labelTrees:STATE.labelTrees},null,2); Utils.downloadFile(`TG_Backup_${Utils.formatKey(new Date())}.json`, b); break;
                        case 'restore': DOM.inputRestore.click(); break;
                        case 'settings-secure': Handlers.showSecureSettings(); break;
                        case 'settings-labels': window.showLabelManagementModal(); break;
                        case 'show-history': Handlers.showHistory(); break;
                        case 'show-debug': Handlers.showDebug(); break;
                        case 'dl-manifest': Handlers.pwaGen.manifest(); break;
                        case 'dl-sw': Handlers.pwaGen.sw(); break;
                        case 'dl-icon': Handlers.pwaGen.icon(); break;
                        case 'show-about': UI.openModal(`<div class="text-center py-6"><i class="fas fa-shield-alt text-5xl text-blue-500 mb-4"></i><h3 class="text-xl font-bold text-slate-800 dark:text-white">現場記録Pro</h3><p class="text-slate-500 text-sm mt-1">${CONFIG.appVersion}</p><button onclick="UI.closeModal()" class="w-full mt-8 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl font-bold text-slate-600 dark:text-slate-400">閉じる</button></div>`); break;
                    }
                } catch(err) { Logger.add('ERROR', 'ClickHandler', err.message); }
            });

            DOM.toggles.dark.addEventListener('change', UI.toggleTheme);
            if(DOM.toggles.debug) DOM.toggles.debug.addEventListener('change', (e) => {
                STATE.devMode.debugNotify = e.target.checked;
                Storage.saveDevMode();
                Logger.addSystem('INFO', 'DevMode', `Debug Notify: ${e.target.checked ? 'ON' : 'OFF'}`);
                if(!e.target.checked) Utils.hideErrorToast();
            });
            DOM.inputRestore.addEventListener('change', (e) => { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if(d.allData) { UI.openConfirm('データを復元しますか？', ()=>{ STATE.allData=d.allData; STATE.labelTrees=d.labelTrees||STATE.labelTrees; Storage.save(); Storage.saveLabels(); UI.renderPage(); Utils.showToast('復元しました'); }); } } catch { Utils.showToast('エラー','error'); } e.target.value=''; }; r.readAsText(f); });
            
            const touchHandler = (e, isMove) => { if(isMove && !STATE.modalDragging) return; if(!isMove) { STATE.modalStartY = e.touches[0].clientY; STATE.modalDragging = true; DOM.modal.container.style.transition = 'none'; return; } const d = e.touches[0].clientY - STATE.modalStartY; if(d>0) DOM.modal.container.style.transform = `translateY(${d}px)`; };
            DOM.modal.handle.addEventListener('touchstart', e => touchHandler(e, false), {passive:true});
            DOM.modal.handle.addEventListener('touchmove', e => touchHandler(e, true), {passive:true});
            DOM.modal.handle.addEventListener('touchend', () => { STATE.modalDragging = false; DOM.modal.container.style.transition = 'transform 0.3s cubic-bezier(0.16,1,0.3,1)'; if(parseInt(DOM.modal.container.style.transform.replace('translateY(','')) > 100) UI.closeModal(); else DOM.modal.container.style.transform = ''; });
            DOM.backdrops.modal.addEventListener('click', UI.closeModal); DOM.backdrops.menu.addEventListener('click', UI.closeMenu);

        } catch(e) {
            Logger.add('CRITICAL', 'Boot', 'Init failed: ' + e.message);
            document.body.innerHTML = `<div style="padding:20px;text-align:center;color:red"><h3>Startup Error</h3><p>${e.message}</p></div>`;
        }
    };
    </script>
</body>
</html>


